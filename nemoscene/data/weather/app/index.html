<!DOCTYPE html>
<html>
    <head>
        <script src="http://localhost:1337/bundle/silvertree/lib/lib.js"></script>
        <style>
            .day_container {
                flex-grow: 1;
                display: inline-block;
                padding: 2px;
                border-radius: 16px;
                text-align: center;
            }

            .day_label {
                font-size: 12px;
                font-weight: 300;
                text-transform: uppercase;
                border-top: 1px solid white;
                padding-top: 4px;
                margin-top: 6px;
            }

            .day_icon {
                display: inline-block;
                font-size: 28px;
                line-height: 0.7;
                margin-bottom: 12px;
            }

            .day_max {
                color: salmon;
            }

            .day_min {
                color: lightskyblue;
            }

            .day_minmax {
                font-size: 12px;
                font-weight: 500;
            }

            .week_box {
                display: flex;
                flex-direction: row;
                justify-content: space-between;
            }

            .today_container {
                display: flex;
                align-items: center;
                flex-direction: row;
                padding: 16px;
                margin-bottom: 12px;
            }

            .today_temperature {
                display: inline-block;
                font-size: 20px;
                font-weight: 700;
                color: #be8fff;
            }

            .today_icon {
                display: inline-block;
                font-size: 96px;
                line-height: 0.7;
                flex-grow: 0;
                margin-right: 24px;
                text-align: center;
            }

            .today_details {
                flex-grow: 1;
            }

            .today_city {
                font-size: 24px;
                font-weight: 700;
            }

            .today_prognosis {
                display: inline-block;
                font-weight: 300;
                font-size: 20px;
            }
        </style>
    </head>
    <body>
        <div class="silvertree_title_bar">
            Weather
        </div>
        <div id="weather_container"></div>

        <script>
            Silvertree.initFramework("weather");

            class WeatherType {
                constructor(code) {
                    switch(code) {
                        case 0:
                            this.label = "Clear";
                            this.icon = "üåû";
                            break;
                        case 1:
                            this.label = "Mostly clear";
                            this.icon = "üå§Ô∏è";
                            break;
                        case 2:
                            this.label = "Partly cloudy";
                            this.icon = "üå•Ô∏è";
                            break;
                        case 3:
                            this.label = "Cloudy";
                            this.icon = "‚òÅÔ∏è";
                            break;
                        case 45:
                            this.label = "Fog";
                            this.icon = "üå´Ô∏è"
                            break;
                        case 48:
                            this.label = "Freezing fog";
                            this.icon = "üå´Ô∏è";
                            break;
                        case 51:
                            this.label = "Light drizzle";
                            this.icon = "üå¶Ô∏è";
                            break;
                        case 53:
                            this.label = "Drizzle";
                            this.icon = "‚òî";
                            break;
                        case 55:
                            this.label = "Heavy drizzle";
                            this.icon = "üåßÔ∏è";
                            break;
                        case 56:
                            this.label = "Light freezing drizzle";
                            this.icon = "üå®Ô∏è";
                            break;
                        case 57:
                            this.label = "Freezing drizzle";
                            this.icon = "üå®Ô∏è";
                            break;
                        case 61:
                            this.label = "Light rain";
                            this.icon = "üåßÔ∏è";
                            break;
                        case 63:
                            this.label = "Rain";
                            this.icon = "üåßÔ∏è";
                            break;
                        case 65:
                            this.label = "Heavy rain";
                            this.icon = "üåßÔ∏è";
                            break;
                        case 66:
                            this.label = "Light freezing rain";
                            this.icon = "üå®Ô∏è";
                            break;
                        case 67:
                            this.label = "Freezing rain";
                            this.icon = "üå®Ô∏è";
                            break;
                        case 71:
                            this.label = "Light snow";
                            this.icon = "üå®Ô∏è";
                            break;
                        case 73:
                            this.label = "Snow";
                            this.icon = "‚ùÑÔ∏è";
                            break;
                        case 75:
                            this.label = "Heavy snow";
                            this.icon = "‚ùÑÔ∏è";
                            break;
                        case 77:
                            this.label = "Snow Grains";
                            this.icon = "‚ùÑÔ∏è";
                            break;
                        case 80:
                            this.label = "Light rain shower";
                            this.icon = "üå¶Ô∏è";
                            break;
                        case 81:
                            this.label = "Rain shower";
                            this.icon = "‚òî";
                            break;
                        case 82:
                            this.label = "Heavy rain shower";
                            this.icon = "üåßÔ∏è";
                            break;
                        case 85:
                            this.label = "Snow shower";
                            this.icon = "üå®Ô∏è";
                            break;
                        case 86:
                            this.label = "Heavy snow shower";
                            this.icon = "üå®Ô∏è";
                            break;
                        case 95:
                            this.label = "Thunderstorm";
                            this.icon = "‚õàÔ∏è";
                            break;
                        case 96:
                            this.label = "Hailstorm";
                            this.icon = "üßä";
                            break;
                        case 99:
                            this.label = "Heavy hailstorm";
                            this.icon = "üßä";
                            break;
                        default:
                            this.label = "Undefined";
                            this.icon = "üåà"
                            break;
                    }
                }
            }

            let city = Silvertree.getConfigurationValue("settings", "location");
            let latitude = 0;
            let longitude = 0;

            class WeatherDay {
                constructor(day, type, min, max) {
                    this.day = day;
                    this.type = type;
                    this.min = min;
                    this.max = max;
                }

                static getWeatherDay(date) {
                    let startday = date;
                    startday = startday.toISOString().split('T')[0];
                    //console.log(`https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&daily=weather_code,temperature_2m_max,temperature_2m_min&timezone=auto&start_day=${startday}&end_day=${startday}`);
                    let response = Silvertree.requestSync("GET", `https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&daily=weather_code,temperature_2m_max,temperature_2m_min&timezone=auto&start_date=${startday}&end_date=${startday}`, null);
                    if(response !== null) {
                        let respo = JSON.parse(response);
                        let type = new WeatherType(respo.daily.weather_code[0]);
                        let min = respo.daily.temperature_2m_min[0];
                        let max = respo.daily.temperature_2m_max[0];
                        return new WeatherDay(date.getDay(), type, min, max);
                    }
                }
            }

            function createDayBox(day) {
                let weather = WeatherDay.getWeatherDay(day);
                let container = document.createElement("div");
                container.classList.add("day_container");
                let label = document.createElement("div");
                label.classList.add("day_label");
                label.innerText = day.toLocaleString("en-US", {weekday: "short"});
                let icon = document.createElement("div");
                icon.classList.add("day_icon");
                icon.innerText = weather.type.icon;
                let max = document.createElement("div");
                max.classList.add("day_max");
                max.classList.add("day_minmax");
                max.innerText = weather.max + "¬∞";
                let min = document.createElement("div");
                min.classList.add("day_min");
                min.classList.add("day_minmax");
                min.innerText = weather.min + "¬∞";
                container.appendChild(icon);
                container.appendChild(max);
                container.appendChild(min);
                container.appendChild(label);
                return container;
            }

            function createTodayBox(day) {
                let container = document.createElement("div");
                container.classList.add("today_container");
                let response = Silvertree.requestSync("GET", `https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&hourly=temperature_2m,weather_code&forecast_days=1&timezone=auto`, null);
                if(response !== null) {
                    let respo = JSON.parse(response);
                    let type = new WeatherType(respo.hourly.weather_code[day.getHours()]);
                    let temp = respo.hourly.temperature_2m[0];

                    let icon = document.createElement("div");
                    icon.classList.add("today_icon");
                    icon.innerText = type.icon;
                    container.appendChild(icon);

                    let details = document.createElement("div");
                    details.classList.add("today_details");

                    let citylabel = document.createElement("div");
                    citylabel.classList.add("today_city");
                    citylabel.innerText = city;
                    details.appendChild(citylabel);

                    let temperature = document.createElement("div");
                    temperature.classList.add("today_temperature");
                    temperature.innerHTML = temp + "¬∞&nbsp;";
                    details.appendChild(temperature);

                    let prognosis = document.createElement("div");
                    prognosis.classList.add("today_prognosis");
                    prognosis.innerText = type.label;
                    details.appendChild(prognosis);

                    container.appendChild(details);
                } else {
                    container.innerText = "Could not get weather data";
                }
                return container;
            }

            function update() {
                document.getElementById("weather_container").innerHTML = "";
                let geolocation = Silvertree.requestSync("GET", "https://geocoding-api.open-meteo.com/v1/search?count=1&&name=" + city, null);
                if(geolocation !== null) {
                    let results = JSON.parse(geolocation).results;
                    if(results.length === 0) {
                        document.getElementById("weather_container").innerText = "Could not find location " + city;
                    } else {
                        latitude = results[0].latitude;
                        longitude = results[0].longitude;

                        let weekbox = document.createElement("div");
                        weekbox.classList.add("week_box");

                        let day = new Date();

                        document.getElementById("weather_container").appendChild(createTodayBox(day));

                        for(let i = 0; i < 7; i++) {
                            weekbox.appendChild(createDayBox(day));
                            day.setDate(day.getDate() + 1);
                        }

                        document.getElementById("weather_container").appendChild(weekbox);
                    }
                } else {
                    document.getElementById("weather_container").innerText = "Could not reach server";
                }
            }

            update();
            setInterval(update, 20 * 60 * 1000);
        </script>
    </body>
</html>